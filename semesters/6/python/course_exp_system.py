import tkinter as tk
from tkinter import messagebox
import ttkbootstrap as ttk
from ttkbootstrap.constants import *

class CarDiagnosticExpertSystem:
    def __init__(self, root):
        self.root = root
        self.root.title("Экспертная система диагностики автомобиля")
        self.root.geometry("800x500")
        self.style = ttk.Style(theme="cosmo")
        self.state = 1
        self.state_history = []
        self.responses = []
        self.started = False

        # Интерфейс
        self.label = ttk.Label(self.root, text="", font=("Helvetica", 16), wraplength=700)
        self.label.pack(pady=20)

        self.response_frame = ttk.Frame(self.root)
        self.response_frame.pack()

        self.yes_btn = ttk.Button(self.response_frame, text="Да", command=lambda: self.next_state("Да"), bootstyle=SUCCESS)
        self.yes_btn.pack(side=tk.LEFT, padx=10)

        self.no_btn = ttk.Button(self.response_frame, text="Нет", command=lambda: self.next_state("Нет"), bootstyle=DANGER)
        self.no_btn.pack(side=tk.LEFT, padx=10)

        self.control_frame = ttk.Frame(self.root)
        self.control_frame.pack(pady=20)

        self.help_btn = ttk.Button(self.control_frame, text="Помощь", command=self.show_help, bootstyle=INFO)
        self.help_btn.pack(side=tk.LEFT, padx=5)

        self.back_btn = ttk.Button(self.control_frame, text="Назад", command=self.go_back, bootstyle=WARNING)
        self.back_btn.pack(side=tk.LEFT, padx=5)

        self.restart_btn = ttk.Button(self.control_frame, text="Начать заново", command=self.restart, bootstyle=SECONDARY)
        self.restart_btn.pack(side=tk.LEFT, padx=5)

        self.result_display = ttk.Label(self.root, text="", font=("Helvetica", 13), wraplength=700, justify="left")
        self.result_display.pack(pady=10)

        # Здесь будут подставлены:
        # Определение вопросов
        self.questions = {
            1: "Автомобиль не заводится?",
            2: "Стартер крутит, но двигатель не запускается?",
            3: "Щелкает ли втягивающее реле при запуске?",
            4: "Напряжение на клеммах аккумулятора ≥ 12 В?",
            5: "Гаснут ли лампы на панели при запуске?",
            6: "Слышен ли звук бензонасоса при включении зажигания?",
            7: "Есть ли искра на свечах зажигания?",
            8: "Есть ли коды ошибок в ЭБУ (горит Check Engine)?",
            9: "Присутствует ли код P0300–P030X (пропуски зажигания)?",
            10: "Присутствует ли код P0171 или P0172 (богатая/бедная смесь)?",
            11: "Запах топлива из выхлопа или чёрный выхлоп?",
            12: "Пробег автомобиля > 150 000 км?",
            13: "Была ли недавно очистка/замена MAF-сенсора?",
            14: "Менялся ли топливный фильтр или насос за последние 2 года?",
            15: "Пропадает ли напряжение при нагрузке (фары, обогрев)?",
            16: "Наблюдаются ли пропуски зажигания или «троение»?",
            17: "Проверялся ли датчик положения коленвала (ДПКВ)?",
            18: "Компрессия в цилиндрах в норме?",
            19: "Производился ли недавно ремонт двигателя или ГРМ?",
            20: "Проверялись ли свечи зажигания?",
            21: "Проверялась ли катушка зажигания?",
            22: "Есть ли посторонние звуки при вращении коленвала?",
            23: "Были ли перебои в работе до остановки?",
            24: "Были ли недавно дожди или влажность?",
            25: "Пробует ли двигатель «схватиться» при запуске?",
            26: "Есть ли код P0115 или P0100 (темп. ОЖ/MAF)?",
            27: "Вставлялись ли нештатные детали (датчики и т.п.)?",
            28: "Проверялась ли целостность предохранителей зажигания и ЭБУ?",
            29: "Выхлоп сизого цвета (масло в цилиндрах)?",
            30: "Все проверки пройдены без выявления проблемы?"
        }
        # Пояснения к вопросам
        self.explanations = {
            1: "Определяет наличие проблемы с запуском — основной симптом.",
            2: "Уточняет, проблема в стартере или в дальнейших системах.",
            3: "Исключает неисправность втягивающего реле стартера.",
            4: "Проверка заряда аккумулятора — источник питания системы.",
            5: "Указывает на критическое падение напряжения при запуске.",
            6: "Проверка подачи топлива — обязательный этап запуска.",
            7: "Диагностирует систему зажигания как причину нестарта.",
            8: "Анализ самодиагностики автомобиля — важный этап.",
            9: "Выявляет нарушения в работе цилиндров двигателя.",
            10: "Обнаруживает проблемы в подаче воздуха или топлива.",
            11: "Признак перелива топлива или неэффективного сгорания.",
            12: "Проверка на износ — возрастные проблемы мотора.",
            13: "Выясняет, возможно ли неверное измерение воздуха.",
            14: "Изношенные компоненты подачи топлива — частая причина.",
            15: "Низкое напряжение при нагрузке указывает на АКБ/генератор.",
            16: "Признак неисправности зажигания или топливоподачи.",
            17: "Ключевой датчик для синхронизации работы двигателя.",
            18: "Проверка механического состояния двигателя.",
            19: "Ошибка синхронизации после ремонта ГРМ/двигателя.",
            20: "Свечи — частая причина пропусков и нестабильности.",
            21: "Неисправная катушка приводит к отсутствию искры.",
            22: "Свидетельствует о повреждениях в ГРМ или ЦПГ.",
            23: "Выявляет предшествующие симптомы перед отказом.",
            24: "Влага может вызвать короткие замыкания.",
            25: "Показывает, есть ли частичный запуск.",
            26: "Связаны с критичными датчиками запуска.",
            27: "Нештатные детали могут вызвать сбои системы.",
            28: "Перегоревшие предохранители отключают питание.",
            29: "Признак износа ЦПГ — масло в цилиндрах.",
            30: "Итог — если всё в норме, вероятна временная ошибка."
        }
        # Переходы состояния: (текущее, ответ) -> следующее
        self.transitions = {
            (1, "Да"): 2, (1, "Нет"): 40,
            (2, "Да"): 3, (2, "Нет"): 5,
            (3, "Да"): 4, (3, "Нет"): 32,
            (4, "Да"): 8, (4, "Нет"): 31,
            (5, "Да"): 31, (5, "Нет"): 6,
            (6, "Да"): 7, (6, "Нет"): 34,
            (7, "Да"): 8, (7, "Нет"): 33,
            (8, "Да"): 9, (8, "Нет"): 11,
            (9, "Да"): 39, (9, "Нет"): 10,
            (10, "Да"): 37, (10, "Нет"): 11,
            (11, "Да"): 12, (11, "Нет"): 13,
            (12, "Да"): 35, (12, "Нет"): 13,
            (13, "Да"): 14, (13, "Нет"): 37,
            (14, "Да"): 15, (14, "Нет"): 34,
            (15, "Да"): 31, (15, "Нет"): 16,
            (16, "Да"): 39, (16, "Нет"): 17,
            (17, "Да"): 18, (17, "Нет"): 38,
            (18, "Да"): 19, (18, "Нет"): 35,
            (19, "Да"): 20, (19, "Нет"): 35,
            (20, "Да"): 21, (20, "Нет"): 33,
            (21, "Да"): 22, (21, "Нет"): 33,
            (22, "Да"): 35, (22, "Нет"): 23,
            (23, "Да"): 24, (23, "Нет"): 25,
            (24, "Да"): 33, (24, "Нет"): 25,
            (25, "Да"): 26, (25, "Нет"): 36,
            (26, "Да"): 36, (26, "Нет"): 27,
            (27, "Да"): 36, (27, "Нет"): 28,
            (28, "Да"): 29, (28, "Нет"): 36,
            (29, "Да"): 35, (29, "Нет"): 30,
            (30, "Да"): 40, (30, "Нет"): 36,
        }
        # Результаты терминальных состояний
        self.results = {
            31: ("Разряжен или неисправен аккумулятор", 
                 "Напряжение ниже 12 В при попытке запуска → заменить или зарядить АКБ."),
            32: ("Неисправен стартер/втягивающее реле", 
                 "Щелчки реле, но нет вращения → проверить стартер и реле."),
            33: ("Отсутствует искра в системе зажигания", 
                 "Искра отсутствует → проверить свечи, катушки, ЭБУ."),
            34: ("Нет подачи топлива в двигатель", 
                 "Бензонасос не звучит → проверить топливный насос, предохранители."),
            35: ("Слишком низкая компрессия", 
                 "Низкая компрессия → проверить ГРМ, цилиндры, поршни."),
            36: ("Ошибка управления двигателем (DTC-коды)", 
                 "Коды ошибок указывают на сбои датчиков/ЭБУ → считать и устранить."),
            37: ("Загрязнённый или неисправный датчик MAF", 
                 "Нередко вызывает обедненную/богатую смесь → очистить или заменить MAF."),
            38: ("Повреждённый датчик коленвала", 
                 "Нет сигнала от ДПКВ → заменить датчик и проверить подключение."),
            39: ("Сбои в системе зажигания при нагрузке", 
                 "Пропуски зажигания с кодом P030X → проверить свечи, высоковольтные провода."),
            40: ("Система исправна — временная или нестабильная ошибка", 
                 "Все проверки пройдены успешно → рекомендовано повторить диагностику позже.")
        }

        self.load_data()
        self.label.config(text="Добро пожаловать в экспертную систему диагностики автомобиля!\n\nНажмите 'Начать', чтобы приступить к диагностике.")
        self.yes_btn.config(text="Начать", command=self.start_diagnosis)
        self.no_btn.pack_forget()

    def start_diagnosis(self):
        self.started = True
        self.state = 1
        self.responses = []
        self.state_history = []
        self.show_question()
        self.yes_btn.config(text="Да", command=lambda: self.next_state("Да"))
        self.no_btn.pack(side=tk.LEFT, padx=10)


    def load_data(self):
        from pprint import pprint

        # Определение вопросов
        self.questions = {
            1: "Автомобиль не заводится?",
            2: "Стартер крутит, но двигатель не запускается?",
            3: "Щелкает ли втягивающее реле при запуске?",
            4: "Напряжение на клеммах аккумулятора ≥ 12 В?",
            5: "Гаснут ли лампы на панели при запуске?",
            6: "Слышен ли звук бензонасоса при включении зажигания?",
            7: "Есть ли искра на свечах зажигания?",
            8: "Есть ли коды ошибок в ЭБУ (горит Check Engine)?",
            9: "Присутствует ли код P0300–P030X (пропуски зажигания)?",
            10: "Присутствует ли код P0171 или P0172 (богатая/бедная смесь)?",
            11: "Запах топлива из выхлопа или чёрный выхлоп?",
            12: "Пробег автомобиля > 150 000 км?",
            13: "Была ли недавно очистка/замена MAF-сенсора?",
            14: "Менялся ли топливный фильтр или насос за последние 2 года?",
            15: "Пропадает ли напряжение при нагрузке (фары, обогрев)?",
            16: "Наблюдаются ли пропуски зажигания или «троение»?",
            17: "Проверялся ли датчик положения коленвала (ДПКВ)?",
            18: "Компрессия в цилиндрах в норме?",
            19: "Производился ли недавно ремонт двигателя или ГРМ?",
            20: "Проверялись ли свечи зажигания?",
            21: "Проверялась ли катушка зажигания?",
            22: "Есть ли посторонние звуки при вращении коленвала?",
            23: "Были ли перебои в работе до остановки?",
            24: "Были ли недавно дожди или влажность?",
            25: "Пробует ли двигатель «схватиться» при запуске?",
            26: "Есть ли код P0115 или P0100 (темп. ОЖ/MAF)?",
            27: "Вставлялись ли нештатные детали (датчики и т.п.)?",
            28: "Проверялась ли целостность предохранителей зажигания и ЭБУ?",
            29: "Выхлоп сизого цвета (масло в цилиндрах)?",
            30: "Все проверки пройдены без выявления проблемы?"
        }
        # Пояснения к вопросам
        self.explanations = {
            1: "Определяется наличие общей проблемы с запуском двигателя. Указывает на необходимость диагностики всех систем, задействованных при старте.",
            2: "Выявляется, есть ли вращение двигателя. Это помогает разделить неисправности механизма запуска и остальных узлов.",
            3: "Втягивающее реле — это часть стартера. Его щелчок без вращения указывает на механическую или электрическую проблему стартера.",
            4: "Если напряжение ниже 12 В, запуск может быть невозможен. Измеряется мультиметром между клеммами аккумулятора.",
            5: "Резкое падение яркости ламп или их отключение указывает на просадку напряжения, что мешает корректной работе стартера.",
            6: "Бензонасос подаёт топливо в двигатель. Отсутствие его звука может свидетельствовать о неисправности питания или самого насоса.",
            7: "Наличие искры на свечах зажигания подтверждает работоспособность системы зажигания. Отсутствие — возможная причина нестарта.",
            8: "Считывание кодов ошибок (DTC) через OBD-II позволяет быстро локализовать неисправности, определённые ЭБУ.",
            9: "Коды P0300–P030X свидетельствуют о пропусках зажигания в одном или нескольких цилиндрах. Это влияет на запуск и стабильность работы.",
            10: "Коды P0171/P0172 связаны с составом топливной смеси (бедной или богатой). Часто причиной являются датчики, подсос воздуха или MAF.",
            11: "Чёрный выхлоп и запах топлива — признаки переобогащённой смеси или неэффективного сгорания топлива.",
            12: "Пробег выше 150 000 км повышает вероятность возрастных неисправностей: износ ЦПГ, загрязнение датчиков и фильтров.",
            13: "MAF-сенсор (датчик массового расхода воздуха) измеряет поступающий воздух. Его загрязнение и неправильная работа влияют на состав смеси.",
            14: "Фильтр и насос подают топливо под нужным давлением. Их износ или засорение ухудшают подачу и работу двигателя.",
            15: "Просадки напряжения под нагрузкой указывают на плохое состояние АКБ, генератора или контактных соединений.",
            16: "Троение и пропуски указывают на проблемы в системе зажигания, подачи топлива или цилиндрах.",
            17: "Датчик положения коленвала (ДПКВ) даёт ЭБУ сигнал синхронизации. При его сбое запуск становится невозможен.",
            18: "Компрессия — показатель состояния ЦПГ. Низкая компрессия свидетельствует о серьёзном износе или повреждении.",
            19: "После ремонта ГРМ возможно нарушение фаз газораспределения. Это влияет на запуск и работу двигателя.",
            20: "Свечи — критический элемент зажигания. Их состояние напрямую влияет на искру и запуск.",
            21: "Катушка зажигания формирует высокое напряжение для свечей. Неисправность приводит к отсутствию искры.",
            22: "Посторонние звуки при вращении коленвала сигнализируют о возможных механических повреждениях.",
            23: "Перебои до остановки помогают выявить прогрессирующие неисправности: датчики, бензонасос, зажигание.",
            24: "Влага и дожди могут вызвать замыкания, особенно в старых системах зажигания или ЭБУ.",
            25: "Попытки «схватиться» указывают на наличие подачи топлива и искры, но возможен сбой синхронизации.",
            26: "Коды P0115/P0100 сигнализируют о неисправности датчиков температуры ОЖ или MAF, что влияет на запуск.",
            27: "Установка нештатных компонентов может нарушать корректную работу систем автомобиля.",
            28: "Целостность предохранителей — критичный фактор для питания ЭБУ и систем запуска.",
            29: "Сизый выхлоп указывает на попадание масла в цилиндры. Это свидетельствует об износе маслосъёмных колец или направляющих клапанов.",
            30: "Отсутствие выявленных проблем при полной проверке указывает на вероятную нестабильную или временную неисправность."
        }
        # Переходы состояния: (текущее, ответ) -> следующее
        self.transitions = {
            (1, "Да"): 2, (1, "Нет"): 40,
            (2, "Да"): 3, (2, "Нет"): 5,
            (3, "Да"): 4, (3, "Нет"): 32,
            (4, "Да"): 8, (4, "Нет"): 31,
            (5, "Да"): 31, (5, "Нет"): 6,
            (6, "Да"): 7, (6, "Нет"): 34,
            (7, "Да"): 8, (7, "Нет"): 33,
            (8, "Да"): 9, (8, "Нет"): 11,
            (9, "Да"): 39, (9, "Нет"): 10,
            (10, "Да"): 37, (10, "Нет"): 11,
            (11, "Да"): 12, (11, "Нет"): 13,
            (12, "Да"): 35, (12, "Нет"): 13,
            (13, "Да"): 14, (13, "Нет"): 37,
            (14, "Да"): 15, (14, "Нет"): 34,
            (15, "Да"): 31, (15, "Нет"): 16,
            (16, "Да"): 39, (16, "Нет"): 17,
            (17, "Да"): 18, (17, "Нет"): 38,
            (18, "Да"): 19, (18, "Нет"): 35,
            (19, "Да"): 20, (19, "Нет"): 35,
            (20, "Да"): 21, (20, "Нет"): 33,
            (21, "Да"): 22, (21, "Нет"): 33,
            (22, "Да"): 35, (22, "Нет"): 23,
            (23, "Да"): 24, (23, "Нет"): 25,
            (24, "Да"): 33, (24, "Нет"): 25,
            (25, "Да"): 26, (25, "Нет"): 36,
            (26, "Да"): 36, (26, "Нет"): 27,
            (27, "Да"): 36, (27, "Нет"): 28,
            (28, "Да"): 29, (28, "Нет"): 36,
            (29, "Да"): 35, (29, "Нет"): 30,
            (30, "Да"): 40, (30, "Нет"): 36,
        }
        # Результаты терминальных состояний
        self.results = {
          31: (
               "Разряжен или неисправен аккумулятор",
               "Причина: Напряжение на клеммах менее 12 В, просадки до 9 В и ниже при запуске.\n"
               "Что это значит: Аккумулятор не способен обеспечить необходимый ток, возможен сульфатация или короткое замыкание.\n"
               "Что делать: Проверить напряжение в покое и под нагрузкой, зарядить или заменить АКБ, очистить клеммы."
          ),
          32: (
               "Неисправен стартер или втягивающее реле",
               "Причина: При повороте ключа слышен щелчок, но стартер не крутит.\n"
               "Что это значит: Неисправен стартер, втягивающее реле или обрыв в цепи питания.\n"
               "Что делать: Проверить наличие питания на стартере, целостность проводки, при необходимости заменить стартер."
          ),
          33: (
               "Отсутствует искра в системе зажигания",
               "Причина: Нет искры на свечах зажигания при прокрутке двигателя.\n"
               "Что это значит: Возможен выход из строя катушки зажигания, свечей или датчика положения коленвала.\n"
               "Что делать: Проверить искру на всех цилиндрах, исправность катушек, ДПКВ и наличие сигнала на ЭБУ."
          ),
          34: (
               "Отсутствует подача топлива в двигатель",
               "Причина: Не слышно работы бензонасоса при включении зажигания.\n"
               "Что это значит: Возможен обрыв питания, неисправность реле или самого насоса.\n"
               "Что делать: Проверить реле, предохранители, подачу питания к насосу. При необходимости заменить насос."
          ),
          35: (
               "Слишком низкая компрессия в цилиндрах",
               "Причина: Давление в цилиндрах ниже нормы (обычно менее 9 бар).\n"
               "Что это значит: Износ ЦПГ, прогар клапанов, обрыв ремня ГРМ или неплотности в ГБЦ.\n"
               "Что делать: Выполнить замер компрессии и/или тест утечек, выявить повреждения, провести ремонт."
          ),
          36: (
               "Ошибка управления двигателем (DTC-коды)",
               "Причина: ЭБУ зарегистрировал ошибки в системах двигателя.\n"
               "Что это значит: Проблемы в датчиках, исполнительных устройствах или логике работы ЭБУ.\n"
               "Что делать: Считать коды OBD-II сканером, устранить неисправности по кодам, стереть ошибки и перепроверить."
          ),
          37: (
               "Загрязнённый или неисправный датчик MAF",
               "Причина: Данные MAF некорректны или отсутствуют.\n"
               "Что это значит: Неверный расчёт воздушной смеси приводит к неправильному впрыску топлива.\n"
               "Что делать: Очистить датчик MAF, проверить питание и сигнальные цепи, заменить при необходимости."
          ),
          38: (
               "Повреждён датчик положения коленвала (ДПКВ)",
               "Причина: Нет сигнала от ДПКВ при прокрутке двигателя.\n"
               "Что это значит: ЭБУ не получает информацию о положении коленвала, запуск невозможен.\n"
               "Что делать: Проверить датчик, проводку, заменить ДПКВ, если не выдаёт импульсы."
          ),
          39: (
               "Сбои в системе зажигания при нагрузке",
               "Причина: Обнаружены пропуски зажигания, ошибки P0300–P030X.\n"
               "Что это значит: Нарушена работа одного или нескольких цилиндров из-за свечей, катушек или форсунок.\n"
               "Что делать: Проверить и заменить свечи, катушки, проверить форсунки и компрессию."
          ),
          40: (
               "Система исправна — временная или нестабильная ошибка",
               "Причина: Диагностика не выявила постоянных ошибок.\n"
               "Что это значит: Возможен эпизодический сбой в датчике, соединении или ЭБУ.\n"
               "Что делать: Повторить тест позже, проверить разъёмы и питание, следить за поведением двигателя."
          )
          }



    def show_question(self):
        if not self.started:
            return
        if self.state in self.questions:
            self.label.config(text=self.questions[self.state])
            self.result_display.config(text="")
            self.yes_btn.pack(side=tk.LEFT, padx=10)
            self.no_btn.pack(side=tk.LEFT, padx=10)
        else:
            self.show_result()


    def next_state(self, answer):
        self.state_history.append(self.state)
        self.responses.append((self.state, answer))
        key = (self.state, answer)
        self.state = self.transitions.get(key, self.state)
        self.show_question()

    def go_back(self):
        if self.state_history:
            self.state = self.state_history.pop()
            self.responses.pop()
            self.show_question()

    def restart(self):
        self.state = 1
        self.responses = []
        self.state_history = []
        self.show_question()

    def show_help(self):
        text = self.explanations.get(self.state, "Нет пояснения для этого вопроса.")
        messagebox.showinfo("Пояснение", text)

    def show_result(self):
        result_title, result_desc = self.results.get(self.state, ("Неизвестная проблема", ""))
        text = f"\nДиагноз: {result_title}\n\n{result_desc}"
        self.label.config(text="Результат диагностики")
        self.result_display.config(text=text)
        self.yes_btn.pack_forget()
        self.no_btn.pack_forget()

if __name__ == "__main__":
    root = ttk.Window(themename="cosmo")
    app = CarDiagnosticExpertSystem(root)
    root.mainloop()
